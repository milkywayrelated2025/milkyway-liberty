<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>üé¨ API Fusion Vid√©o</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .dropzone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 20px; }
        button { padding: 10px 20px; margin-right: 10px; }
        #result { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>
    <h1>üé¨ API Fusion Vid√©o</h1>
    <p>Version Optimis√©e - Validation + Normalisation Conditionnelle</p>

    <div>
        <h2>üì§ Upload des Vid√©os</h2>
        <div class="dropzone" id="dropzone">
            Glissez vos vid√©os ici ou cliquez pour s√©lectionner<br>
            Formats support√©s: MP4, AVI, MOV (Max 100MB)
        </div>
        <input type="file" id="fileInput" multiple accept="video/*" style="display: none;">
    </div>

    <div>
        <h2>‚ö° Actions</h2>
        <button id="mergeBtn">üé¨ FUSIONNER LES VID√âOS</button>
        <button id="cleanupBtn">üóëÔ∏è NETTOYER</button>
        <button id="statusBtn">üìä STATUT</button>
        <div id="progress">Pr√©paration...</div>
    </div>

    <div>
        <h2>üìã R√©sultat</h2>
        <div id="result"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const apiUrl = window.location.origin || 'https://milkyway-liberty-production.up.railway.app'; // Fallback si origin undefined
        const apiKey = 'supersecretkey'; // Mets ta cl√© ici
        
        // G√©n√©rer un sessionId unique pour cette session
        const sessionId = Date.now().toString();
        console.log('Session ID:', sessionId);

        // Connexion Socket.IO
        const socket = io(apiUrl);
        let socketId = null;

        socket.on('connect', () => {
            socketId = socket.id;
            console.log('üîå Connect√© au serveur:', socketId);
        });

        socket.on('disconnect', () => {
            console.log('üîå D√©connect√© du serveur');
        });

        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const mergeBtn = document.getElementById('mergeBtn');
        const cleanupBtn = document.getElementById('cleanupBtn');
        const statusBtn = document.getElementById('statusBtn');
        const progress = document.getElementById('progress');
        const result = document.getElementById('result');

        // Drag & Drop
        dropzone.addEventListener('click', () => fileInput.click());
        dropzone.addEventListener('dragover', e => e.preventDefault());
        dropzone.addEventListener('drop', e => {
            e.preventDefault();
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', e => handleFiles(e.target.files));

        async function handleFiles(files) {
            for (let file of files) {
                progress.textContent = `Upload de ${file.name}...`;
                const formData = new FormData();
                formData.append('video', file);
                try {
                    const res = await fetch(`${apiUrl}/upload?sessionId=${sessionId}`, {
                        method: 'POST',
                        headers: { 'x-api-key': apiKey },
                        body: formData
                    });
                    const data = await res.json();
                    progress.textContent = `Upload OK: ${file.name}`;
                } catch (err) {
                    progress.textContent = 'Erreur upload';
                }
            }
        }

        // √âcouter la progression de fusion
        socket.on('merge-progress', (data) => {
            console.log('üìä Progression:', data);
            
            let progressText = data.message;
            if (data.progress !== undefined) {
                progressText = `${data.message} (${data.progress}%)`;
            }
            
            progress.textContent = progressText;
            
            // Mettre √† jour l'interface avec une barre de progression
            if (data.progress !== undefined) {
                progress.innerHTML = `
                    <div style="margin: 10px 0;">
                        <div style="background: #f0f0f0; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #4CAF50, #45a049); 
                                        height: 100%; width: ${data.progress}%; 
                                        transition: width 0.3s ease; border-radius: 10px;"></div>
                        </div>
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                            ${data.message} - Temps restant: ${data.eta || 'calcul...'}
                        </div>
                    </div>
                `;
            }
        });

        mergeBtn.addEventListener('click', async () => {
            progress.textContent = 'D√©marrage de la fusion...';
            try {
                const res = await fetch(`${apiUrl}/merge`, {
                    method: 'POST',
                    headers: { 
                        'x-api-key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        sessionId: sessionId,
                        socketId: socketId 
                    })
                });
                const data = await res.json();
                result.innerHTML = `<p>‚úÖ Fusion termin√©e: <a href="${apiUrl}${data.output}">T√©l√©charger</a></p>`;
                progress.textContent = '‚úÖ Fusion termin√©e avec succ√®s !';
            } catch (err) {
                result.textContent = '‚ùå Erreur fusion: ' + err.message;
                progress.textContent = '‚ùå √âchec de la fusion';
            }
        });

        cleanupBtn.addEventListener('click', async () => {
            progress.textContent = 'Nettoyage...';
            await fetch(`${apiUrl}/cleanup`, { method: 'DELETE', headers: { 'x-api-key': apiKey } });
            progress.textContent = 'Nettoyage OK';
        });

        statusBtn.addEventListener('click', async () => {
            progress.textContent = 'R√©cup√©ration statut...';
            const res = await fetch(`${apiUrl}/health`);
            const data = await res.json();
            result.textContent = JSON.stringify(data, null, 2);
            progress.textContent = 'Statut OK';
        });
    </script>
</body>
</html>